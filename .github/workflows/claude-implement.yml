name: Claude Code - Feature Implementation

on:
  issues:
    types: [labeled]

jobs:
  implement:
    if: github.event.label.name == 'claude'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: "--model claude-opus-4-6 --max-turns 100 --allowedTools Bash,Read,Write,Edit,Glob,Grep"
          prompt: |
            Du bist ein erfahrener Entwickler fuer das FOF Stats Projekt.
            Lies CLAUDE.md im Repository-Root fuer alle Projekt-Konventionen.

            Wichtige Regeln:
            - Verwende `var` statt `const`/`let` im Frontend-JavaScript
            - Nutze immer `escapeHtml()` bei innerHTML mit User-Daten
            - Halte das DOS/Win95 Retro-Theme ein (Monospace, outset/inset Borders, gruener Akzent)
            - Alle UI-Texte auf Deutsch
            - Folge dem Feature-Modul-Pattern (IIFE CSS, Header-Kommentar, init-Funktion)
            - server.js ist eine einzelne grosse Datei - nicht aufteilen

            Implementiere das folgende Feature:
            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            ${{ github.event.issue.body }}

            Committe deine Aenderungen auf einem neuen Branch (z.B. feature/issue-${{ github.event.issue.number }}).
            Pushe den Branch. Erstelle KEINEN PR - das wird automatisch gemacht.

      - name: Create Pull Request
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Pr√ºfe ob ein neuer Branch erstellt wurde
          CURRENT_BRANCH=$(git branch --show-current)
          if [ "$CURRENT_BRANCH" = "main" ]; then
            # Claude hat vielleicht auf einem anderen Branch gearbeitet
            FEATURE_BRANCH=$(git branch -r --sort=-committerdate | grep -v 'origin/main' | head -1 | sed 's|origin/||' | xargs)
            if [ -z "$FEATURE_BRANCH" ]; then
              echo "Kein Feature-Branch gefunden, ueberspringe PR-Erstellung"
              exit 0
            fi
          else
            FEATURE_BRANCH="$CURRENT_BRANCH"
          fi

          echo "Feature-Branch: $FEATURE_BRANCH"

          # PR erstellen
          gh pr create \
            --base main \
            --head "$FEATURE_BRANCH" \
            --title "${{ github.event.issue.title }}" \
            --body "$(cat <<'EOF'
          ## Automatisch implementiert von Claude Code

          Closes #${{ github.event.issue.number }}

          Dieses Feature wurde automatisch durch Claude Code (Opus 4.6) implementiert.
          Bitte den Code reviewen bevor gemerged wird.

          ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
          EOF
          )"
