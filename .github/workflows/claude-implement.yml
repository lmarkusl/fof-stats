name: Claude Code - Feature Implementation

on:
  issues:
    types: [labeled]

jobs:
  implement:
    if: github.event.label.name == 'claude'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: "--model claude-opus-4-6 --max-turns 100 --allowedTools Bash,Read,Write,Edit,Glob,Grep"
          prompt: |
            Du bist ein erfahrener Entwickler fuer das FOF Stats Projekt.
            Lies CLAUDE.md im Repository-Root fuer alle Projekt-Konventionen.

            Wichtige Regeln:
            - Verwende `var` statt `const`/`let` im Frontend-JavaScript
            - Nutze immer `escapeHtml()` bei innerHTML mit User-Daten
            - Halte das DOS/Win95 Retro-Theme ein (Monospace, outset/inset Borders, gruener Akzent)
            - Alle UI-Texte auf Deutsch
            - Folge dem Feature-Modul-Pattern (IIFE CSS, Header-Kommentar, init-Funktion)
            - server.js ist eine einzelne grosse Datei - nicht aufteilen

            Implementiere das folgende Feature:
            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            ${{ github.event.issue.body }}

            Committe deine Aenderungen auf einem neuen Branch (z.B. feature/issue-${{ github.event.issue.number }}).
            Pushe den Branch. Erstelle KEINEN PR - das wird automatisch gemacht.

      - name: Find feature branch
        id: find-branch
        run: |
          git fetch origin
          FEATURE_BRANCH=$(git branch -r --sort=-committerdate | grep -v 'origin/main' | grep -v 'HEAD' | head -1 | sed 's|origin/||' | xargs)
          echo "branch=$FEATURE_BRANCH" >> "$GITHUB_OUTPUT"
          echo "Feature-Branch: $FEATURE_BRANCH"

      - name: Create Pull Request
        if: steps.find-branch.outputs.branch != ''
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${{ github.event.issue.title }}`,
              head: `${{ steps.find-branch.outputs.branch }}`,
              base: 'main',
              body: `## Automatisch implementiert von Claude Code\n\nCloses #${{ github.event.issue.number }}\n\nDieses Feature wurde automatisch durch Claude Code (Opus 4.6) implementiert.\nBitte den Code reviewen bevor gemerged wird.\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)`
            });
            console.log(`PR erstellt: ${pr.data.html_url}`);
